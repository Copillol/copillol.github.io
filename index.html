<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberPlug Survey</title>
    <link rel="stylesheet" href="assets/css/bootstrap-4.5.0.min.css">
    <script type="module">
        // Importa le funzioni necessarie dagli SDK di Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // Configurazione di Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCSFWaeBg7GUg4vPYe_niuy8HAIh_gxT9k",
            authDomain: "cyberpsurvey.firebaseapp.com",
            projectId: "cyberpsurvey",
            storageBucket: "cyberpsurvey.appspot.com",
            messagingSenderId: "944614697169",
            appId: "1:944614697169:web:7a77c814728450928ebdf0",
            measurementId: "G-QXX1HY57FS"
        };

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('survey-form');
            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                const option = document.getElementById('q1').value;
                const ip = await getIp();

                // Controlla se l'utente ha già votato (usando l'IP)
                const q = query(collection(db, 'votes'), where('ip', '==', ip));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    // Aggiungi il voto al database
                    await addDoc(collection(db, 'votes'), { option, ip });
                    alert('Grazie per aver completato il sondaggio!');
                    loadResults();
                } else {
                    alert('Hai già votato.');
                }
            });

            async function loadResults() {
                const votesCollection = collection(db, 'votes');
                const querySnapshot = await getDocs(votesCollection);
                let results = {};

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    results[data.option] = (results[data.option] || 0) + 1;
                });

                let resultsHtml = '<h3>Risultati del Sondaggio:</h3><ul>';
                for (let [option, count] of Object.entries(results)) {
                    resultsHtml += `<li>${option}: ${count} voti</li>`;
                }
                resultsHtml += '</ul>';
                document.getElementById('results').innerHTML = resultsHtml;
            }

            async function getIp() {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            }

            loadResults();
        });
    </script>
</head>
<body>
    <div class="container mt-5">
        <h2>CyberPlug Survey</h2>
        <form id="survey-form">
            <div class="form-group">
                <label for="q1">Ti senti al sicuro dal punto di vista informatico nella tua casa?</label>
                <select class="form-control" id="q1" name="q1" required>
                    <option value="">Seleziona un'opzione</option>
                    <option value="molto-sicuro">Molto sicuro</option>
                    <option value="abbastanza-sicuro">Abbastanza sicuro</option>
                    <option value="neutrale">Né sicuro né insicuro</option>
                    <option value="abbastanza-insicuro">Abbastanza insicuro</option>
                    <option value="molto-insicuro">Molto insicuro</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Invia</button>
        </form>
        <div id="results" class="mt-4"></div>
    </div>
</body>
</html>
